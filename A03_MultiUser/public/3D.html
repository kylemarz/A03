<!DOCTYPE html>
<html>
    <head>
        <title>Assignment 03 multi User</title>
        <meta charset="utf-8" />
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v1.16.0/dist/aframe-extras.min.js"></script>
        
    </head>

   <!--- <script>
		AFRAME.registerComponent('cube-man', {
			init: function(){
				//console.log('cube-man');
				let countX = 10;
				let cubes = [];
				let size = 0.125, spacing = 0.05, x;
				let sceneEl = document.querySelector('a-scene');
				for (let i=0; i<countX; i++){
					cubes[i] = document.createElement('a-entity'); // create the element
           // create components, id, geometry, position
					cubes[i].setAttribute('id', 'box_'+i.toString());
					cubes[i].setAttribute('geometry', {
						primitive: 'box',
						height: size,
						width: size,
						depth: size
					});
					x = (size + spacing) * countX * (-0.5) + i * (size + spacing) ;
					y = Math.random() * 0.25;
					cubes[i].setAttribute('position', x.toString()+ ' '+y.toString()+' 0' );
          
          // you can add event listeners here for interaction, such as mouse events.
					sceneEl.appendChild(cubes[i]);// Append the element to the scene, so it becomes part of the DOM.
				}
        // If you want to access THREEjs properties, you need to access them after they have loaded into the scene.
        // Get the cubes as THREEjs object
				cubePosArr = [];
				cubes.forEach(function(c){
					c.addEventListener('loaded', function(ev){
						let cube3D = c.getObject3D('mesh');
						//console.log(cube3D);
						cubePosArr.push(cube3D.position.x);
						console.log(cubePosArr);
					});
				});
			}
		});
	</script>-->

    <script>
        
        AFRAME.registerComponent('collison-check', {
          schema: {
            el: {
              type: 'selector'
            },
            radius: {
              default: 0
            },
            otherRadius: {
              default: 0
            },
            score:{
              type: 'int',
              default: 0
            },
            colliding:{
              default: false
            }
          },
          tick: function () {
            var el1 = this.el;
            var el2 = this.data.el;
            var dist = el1.object3D.getWorldPosition().distanceTo(el2.object3D.getWorldPosition());
            var entity = document.querySelector('#score');
            if (dist < this.data.radius + this.data.otherRadius) {
              if (!this.data.colliding){
                this.data.score++;
                this.data.colliding = true;
                entity.emit('updateScore');
                AFRAME.utils.entity.setComponentProperty(entity, 'text.value', "score \n" + this.data.score);
              }
            } else {
              this.data.colliding = false;
            }
          }
        });
      </script>

    <body>
        <!-- our buttond to tell others -->
        <!-- <button id="red" style="background-color:rgb(255, 0, 0); color:rgb(255, 255, 255)">RED</button>
        <button id="blue" style="background-color:rgb(0, 0, 255); color:rgb(255, 255, 255)">BLUE</button> -->

        <!--each time the 3d player clicks on a object, the background color should change to reveal a differenlty coloured object somewhere else in the scene. -->
        <!--combining  the color game idea and my object picking game -->    
        <a-scene background="color:rgb(80, 80, 80);" antialias="true" >
            <a-entity camera wasd-controls look-controls position="0 1.6 0">
                <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
            </a-entity>

           <!-- <a-entity id="cubes" cube-man></a-entity>-->

            <a-entity class="ground"  geometry="primitive:plane; width:14; height:14;" material="color:grey;" position="0 0.01 0" rotation="-90 0 0"></a-entity>
    
           <!--controller for mobile phone in VR mode --> 
            <a-camera>
                <a-cursor cursor="fuse: true; fuseTimeout: 1500" position="0 0 -0.5" geometry="primitive: sphere; radius: 0.008"
                    material="color:black; shader: flat; opacity: 0.5"> 
                    <!-- <a-animation attribute="material.color" from="black" to="white" dur="1500" fill="backwards" begin="cursor-fusing"></a-animation> -->

                </a-cursor>
            </a-camera>

            <!-- Green box primitives -->
            <a-entity id="green_box" position="1 0.7 -2" animation__click="property: position; to: 0 0 0; startEvents:click; dur:2000" collison-check="el: .ground; radius: 0.15; other-radius: 0.15;">
                <a-entity class="button interactive" position="0 0 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.5;" material="color:rgb(0, 255, 0)" shadow
                    animation__mouseenter="property:scale; from:1 1 1; to:1.2 1.2 1.2; startEvents:mouseenter; dur:300" shadow
                    animation__mouseleave="property:scale; from:1.2 1.2 1.2; to:1 1 1; startEvents:mouseleave; dur:300" shadow
                    >
                   <!--<a-animation attribute="postition"  from="2 2 2" to="1 1 1" dur="300" startEvents="click"></a-animation>-->
                </a-entity>
            </a-entity>

            <a-entity id="score" position="-2.5 1 -2" rotation="0 45 0" text="width: 4; align: center; color: black; value: Score \n 000">
                <a-animation attribute="rotation" to="0 405 0"  easing="linear" fill="both" dur="800" begin="updateScore" > </a-animation>
                <a-box color="#fed6fa" position ="0 0 -0.05" scale="0.8 0.6 0.1"> </a-box>
                <a-box color="#fed6fa" position ="0 -0.7 -0.05" scale="0.1 1 0.1"> </a-box>
              </a-entity>
       
            <!-- red button -->
            <!--<a-entity id="red_button" position="2 0.6 -1">
                <a-entity class="button interactive" position="0 0.6 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(255, 100, 100)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(255, 100, 100); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.55; to:0.6; startEvents:click; dur:300" shadow></a-entity>
                <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.6;" material="color:rgb(255, 255, 255)" shadow></a-entity>
            </a-entity>-->

            <!-- blue button -->
            <!--<a-entity id="blue_button" position="-2 0.6 -1">
                <a-entity class="button interactive" position="0 0.6 0" geometry="primitive:cylinder; radius:0.15; height:0.2;" material="color:rgb(100, 100, 255)"
                            animation__mouseenter="property:material.color; type:color; to:rgb(0, 0, 255); startEvents:mouseenter; dur:200"
                            animation__mouseleave="property:material.color; type:color; to:rgb(100, 100, 255); startEvents:mouseleave; dur:200"
                            animation__click="property:position.y; from:0.55; to:0.6; startEvents:click; dur:300" shadow></a-entity>
                <a-entity position="0 0.3 0" geometry="primitive:box; width:0.5; depth:0.5; height:0.6;" material="color:rgb(255, 255, 255)" shadow></a-entity>
            </a-entity>-->
            
        </a-scene>

        <!-- this is magic code created when the node server runs -->
        <!-- putting at teh bottom of body to let body load first before we try to query for elements -->
        <!-- //VERY HANDY! https://socket.io/docs/v3/emit-cheatsheet/  -->
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();

            socket.on('connect', (userData) => {
                console.log('I exist!');

                //put code here so that we know that socket.io has initailized ...
                document.querySelector('#red_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('red');
                });

                document.querySelector('#blue_button').querySelector('.button').addEventListener('click', function(){
                    socket.emit('blue');
                });

                document.querySelector('#green_box').querySelector('.button').addEventListener('click', function(){
                    socket.emit('green');
                });
            });

            //listen to event from server
            socket.on('color_change', (data) => {
                let colorStr = 'rgb(' + data.r + ',' + data.g + ',' + data.b + ')';
                console.log('color_change:' + colorStr);
                //document.body.style.backgroundColor = colorStr;
                //document.querySelector('a-scene').setAttribute('background', {color:colorStr});
                //document.querySelector('.ground').setAttribute('material', {color:colorStr});
                document.querySelector('#green_box').querySelector('.button').setAttribute('material', {color:colorStr});
            });
        </script>
    </body>
</html>
