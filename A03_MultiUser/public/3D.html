<!DOCTYPE html>
<html>
    <head>
        <title>Assignment 03 multi User</title>
        <meta charset="utf-8" />
        <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
        <script src="https://cdn.rawgit.com/donmccurdy/aframe-extras/v1.16.0/dist/aframe-extras.min.js"></script>
        
    </head>

  

    <script>
        
        AFRAME.registerComponent('collison-check', {
          schema: {
            el: {
              type: 'selector'
            },
            radius: {
              default: 0
            },
            otherRadius: {
              default: 0
            },
            score:{
              type: 'int',
              default: 0
            },
            colliding:{
              default: false
            }
          },
          tick: function () {
            var el1 = this.el;
            var el2 = this.data.el;
            var dist = el1.object3D.getWorldPosition().distanceTo(el2.object3D.getWorldPosition());
            var entity = document.querySelector('#score');
            if (dist < this.data.radius + this.data.otherRadius) {
              if (!this.data.colliding){
                this.data.score++;
                this.data.colliding = true;
                entity.emit('updateScore');
                AFRAME.utils.entity.setComponentProperty(entity, 'text.value', "score \n" + this.data.score);
              }
            } else {
              this.data.colliding = false;
            }
          }
        });
      </script>

    <body>
           
        <a-scene background="color:rgb(80, 80, 80);" antialias="true" >
            <a-entity camera wasd-controls look-controls position="0 1.6 0">
                <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive"></a-entity>
            </a-entity>


            <a-entity class="ground"  geometry="primitive:plane; width:14; height:14;" material="color:grey;" position="0 0.01 -3" rotation="-90 0 0"></a-entity>
    
           <!--controller for mobile phone in VR mode --> 
            <a-camera>
                <a-cursor cursor="fuse: true; fuseTimeout: 1500" position="0 0 -0.5" geometry="primitive: sphere; radius: 0.008"
                    material="color:black; shader: flat; opacity: 0.5"> 
                    <!-- <a-animation attribute="material.color" from="black" to="white" dur="1500" fill="backwards" begin="cursor-fusing"></a-animation> -->

                </a-cursor>
            </a-camera>

            <a-entity id="ball" position="0 -2 -3" geometry="primitive:sphere; radius: .25;" material="color:rgb(0,255,0)"> </a-entity>

            <a-entity id="cup1" position="-2 0.5 -3">
              <a-entity class="button interactive" geometry="primitive:cylinder; radius: 0.5; height: 1"
                material="color:rgb(255,0,0)"
                animation__mouseenter="property:material.color; type:color; to:rgb(255, 100, 100); startEvents:mouseenter; dur:200"
                animation__mouseleave="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseleave; dur:200"
                animation__click="property:position.y; to:0.6; startEvents:click; dur:300" shadow>
              </a-entity>
            </a-entity>
            <a-entity id="cup2" position="0 0.5 -3">
              <a-entity class="button interactive" geometry="primitive:cylinder; radius: 0.5; height: 1"
                material="color:rgb(255,0,0)"
                animation__mouseenter="property:material.color; type:color; to:rgb(255, 100, 100); startEvents:mouseenter; dur:200"
                animation__mouseleave="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseleave; dur:200"
                animation__click="property:position.y; to:0.6; startEvents:click; dur:300" shadow></a-entity>
            </a-entity>
            <a-entity id="cup3" position="2 0.5 -3">
              <a-entity class="button interactive" geometry="primitive:cylinder; radius: 0.5; height: 1"
                material="color:rgb(255,0,0)"
                animation__mouseenter="property:material.color; type:color; to:rgb(255, 100, 100); startEvents:mouseenter; dur:200"
                animation__mouseleave="property:material.color; type:color; to:rgb(255, 0, 0); startEvents:mouseleave; dur:200"
                animation__click="property:position.y; to:0.6; startEvents:click; dur:300" shadow></a-entity>
            </a-entity>


            <a-entity id="score" position="0 2.5 -5" rotation="0 0 0" text="width: 6; align: center; color: black; ">
              <a-animation attribute="rotation" to="0 405 0"  easing="linear" fill="both" dur="800" begin="updateScore" > </a-animation>
              <a-box color="#fed6fa" position ="0 0 -0.05" scale="1.5 1 0.1"> </a-box>
            </a-entity>
              
            <a-entity id="resetButton" position="2 2.5 -5" text="width: 6; align: center; color: white; value: Reset \n game" >
              <a-entity class="button interactive" geometry="primitive:box; height: 1; width: 1; depth: 0.1" material="color:rgb(10,10,10)" position ="0 0 -0.05"> </a-entity>
            </a-entity>  
            
           
            
        </a-scene>

        <!-- this is magic code created when the node server runs -->
        <!-- putting at teh bottom of body to let body load first before we try to query for elements -->
        <!-- //VERY HANDY! https://socket.io/docs/v3/emit-cheatsheet/  -->
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();

            socket.on('connect', (userData) => {
                console.log('I exist!');

                //put code here so that we know that socket.io has initailized ...
                document.querySelector('#cup1').querySelector('.button').addEventListener('click', function(){
                    socket.emit('cup11');
                });

                document.querySelector('#cup2').querySelector('.button').addEventListener('click', function(){
                    socket.emit('cup22');
                });

                document.querySelector('#cup3').querySelector('.button').addEventListener('click', function(){
                    socket.emit('cup33');
                });

                document.querySelector('#resetButton').querySelector('.button').addEventListener('click', function(){
                    socket.emit('resetGame');
                });
            });

            //listen to event from server
            socket.on('cup1', () => {
                
                document.querySelector('#ball').setAttribute('position', {x:-2, y:0.2, z:-3})
                
            });

            socket.on('cup2', () => {
                
                document.querySelector('#ball').setAttribute('position', {x:0, y:0.2, z:-3})
                
            });

            socket.on('cup3', () => {
                
                document.querySelector('#ball').setAttribute('position', {x:2, y:0.2, z:-3})
                
            });

            socket.on('resetGame', () => {
                
                window.location.reload();
                
            });


            socket.on('winner', () => {
                
                document.querySelector('#score').setAttribute('text', 'value: winner' )
                
            });
        </script>
    </body>
</html>
